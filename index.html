<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>タイマー</title>
<style>
  body{
    background:#fff;
    color:#000;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    margin:0;
    padding:0;
  }
  header{
    position:sticky;
    top:0;
    background:#fff;
    border-bottom:2px solid #001f3f;
    padding:10px;
    z-index:10;
  }
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  button{
    border:2px solid #001f3f;
    background:#fff;
    color:#001f3f;
    border-radius:8px;
    padding:5px 6px;
    font-weight:600;
    cursor:pointer;
    min-width:50px;
    font-size:13px;
  }
  button:disabled{
    border-color:#ccc;
    color:#aaa;
    cursor:not-allowed;
  }
  .btn-blue{
    background:#007BFF;
    border-color:#007BFF;
    color:#fff;
  }

  main{
    padding-bottom:16px;
  }

  /* ===== グループ一覧用 ===== */
  #groupView{
    padding:16px;
  }
  .group-list{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }
  .group-card{
    border:2px solid #001f3f;
    border-radius:10px;
    padding:10px;
    min-width:220px;
    max-width:260px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .group-name{
    font-weight:700;
    font-size:15px;
    word-break:break-all;
  }
  .group-buttons{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }

  /* ===== タイマー一覧用 ===== */
  .list{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:min-content;
    gap:16px;
    padding:16px;
  }
  .column{
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .timer{
    border:2px solid #001f3f;
    border-radius:10px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    width:300px;
    background:#fff;
  }
  .timer input[type=text]{
    border:1px solid #001f3f;
    border-radius:6px;
    padding:3px;
    width:100%;
    font-size:15px;
  }
  .timer.done{
    border-color:#ff9800;
    background:#fff7e0;
  }
  .time{
    font-variant-numeric:tabular-nums;
    font-size:34px;
    font-weight:800;
    text-align:center;
    margin:10px 0;
  }
  .presets{
    display:flex;
    justify-content:center;
    gap:6px;
    flex-wrap:nowrap;
  }
  .progress{
    width:100%;
    height:10px;
    background:#eee;
    border:1px solid #001f3f;
    border-radius:5px;
    overflow:hidden;
  }
  .bar{
    height:100%;
    width:0;
    background:#001f3f;
    transition:width .3s;
  }

  /* --- 完了モーダル --- */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.5);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
  }
  .modal-inner{
    background:#fff;
    padding:20px;
    border-radius:10px;
    max-width:400px;
    width:90%;
    text-align:center;
  }
  .modal-inner h3{
    margin-top:0;
  }
  .modal-buttons{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:15px;
  }
</style>
</head>
<body>
<header>
  <div class="toolbar" id="toolbar"></div>
  <!-- ファイル入力は常設（ヘッダー内に見せたいけどdisplay:noneなのでOK） -->
  <input type="file" id="importCsvInput" accept=".csv" style="display:none">
</header>

<main>
  <!-- グループ一覧ビュー -->
  <div id="groupView">
    <div id="groupList" class="group-list"></div>
  </div>

  <!-- タイマービュー -->
  <div id="timerView" style="display:none">
    <div class="list" id="list"></div>
  </div>
</main>

<!-- 完了モーダル -->
<div id="doneModal" class="modal">
  <div class="modal-inner">
    <h3>タイマー完了</h3>
    <p>以下のタイマーが完了しました：</p>
    <ul id="doneList"></ul>
    <div class="modal-buttons">
      <button id="doneStop">音を止める</button>
      <button id="doneOk" class="btn-blue">OK</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ========= Firebase 初期化 =========
  const firebaseConfig = {
    apiKey: "AIzaSyCSIIPz6Q8RRH1ijLcU-SD74IWk10lt2Uk",
    authDomain: "multi-timer-share.firebaseapp.com",
    projectId: "multi-timer-share",
    storageBucket: "multi-timer-share.firebasestorage.app",
    messagingSenderId: "619054972489",
    appId: "1:619054972489:web:ee1a5ad15da335f2e68998",
    databaseURL: "https://multi-timer-share-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ========= DOM 取得 =========
  const toolbar = document.getElementById("toolbar");
  const groupView = document.getElementById("groupView");
  const groupListEl = document.getElementById("groupList");
  const timerView = document.getElementById("timerView");
  const list = document.getElementById("list");

  const importInput = document.getElementById("importCsvInput");
  const doneModal = document.getElementById("doneModal");
  const doneList = document.getElementById("doneList");
  const doneStop = document.getElementById("doneStop");
  const doneOk = document.getElementById("doneOk");

  // ========= 状態 =========
  let timers = {};
  let audioCtx = null;
  let beepInterval = null;
  let unlocked = false;
  let pendingCompletedIds = []; // モーダルにまだ表示中の完了タイマーID

  const urlParams = new URLSearchParams(location.search);
  const currentGroupId = urlParams.get("group"); // nullならグループ一覧モード

  // ========= 共通ユーティリティ =========
  function ensureAudio(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){
        // ブラウザ非対応など
      }
    }else if(audioCtx.state === "suspended"){
      audioCtx.resume();
    }
    unlocked = !!audioCtx;
    return audioCtx;
  }

  function beepPatternOnce(){
    const ctx = ensureAudio();
    if(!ctx) return;
    const base = ctx.currentTime;
    const pattern = [1200,1200,1200];
    pattern.forEach((f,i)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(f, base + i*0.16);
      g.gain.setValueAtTime(0.001, base + i*0.16);
      g.gain.exponentialRampToValueAtTime(0.16, base + i*0.17);
      g.gain.exponentialRampToValueAtTime(0.0001, base + i*0.28);
      o.connect(g).connect(ctx.destination);
      o.start(base + i*0.16);
      o.stop(base + i*0.3);
    });
  }

  function startRepeatingBeep(){
    stopRepeatingBeep();
    beepPatternOnce();
    beepInterval = setInterval(beepPatternOnce, 1200);
  }
  function stopRepeatingBeep(){
    if(beepInterval){
      clearInterval(beepInterval);
      beepInterval = null;
    }
  }

  function logEvent(action, detail=""){
    const ts = new Date().toISOString();
    const entry = {
      action,
      detail,
      timestamp: ts,
      groupId: currentGroupId || null
    };
    push(ref(db,"logs"), entry);
  }

  function fmt(sec){
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  // ========= レイアウト切り替え（ヘッダー＆メイン） =========
  function renderHeader(){
    toolbar.innerHTML = "";
    if(!currentGroupId){
      // グループ一覧画面
      toolbar.innerHTML = `<button id="addGroup" class="btn-blue">＋ グループ作成</button>`;
      document.getElementById("addGroup").addEventListener("click", createGroup);
    }else{
      // タイマー画面（グループ内）
      toolbar.innerHTML = `
        <button id="goBack" class="btn-blue">← グループ一覧へ</button>
        <button id="addTimer" class="btn-blue">＋ 新規タイマー</button>
        <button id="exportCsv">CSV書き出し</button>
        <button id="importCsvBtn">CSV読み込み</button>
        <button id="enableSound" class="btn-blue">音を有効化/テスト</button>
      `;
  
      // 戻るボタンの処理
      document.getElementById("goBack").addEventListener("click", () => {
        // URLから group パラメータを削除
        const p = new URLSearchParams(location.search);
        p.delete("group");
        location.search = p.toString();
      });
  
      document.getElementById("addTimer").addEventListener("click", addTimer);
      document.getElementById("exportCsv").addEventListener("click", exportCsv);
      document.getElementById("importCsvBtn").addEventListener("click", () => {
        importInput.value = "";
        importInput.click();
      });
      document.getElementById("enableSound").addEventListener("click", () => {
        ensureAudio();
        beepPatternOnce();
      });
    }
  }


  function renderLayout(){
    if(!currentGroupId){
      // グループ一覧
      groupView.style.display = "";
      timerView.style.display = "none";
    }else{
      // タイマー画面
      groupView.style.display = "none";
      timerView.style.display = "";
    }
  }

  // ========= グループ一覧まわり =========
  function createGroup(){
    const name = prompt("グループ名を入力してください");
    if(name === null) return;
    const trimmed = name.trim();
    if(!trimmed){
      alert("グループ名を入力してください");
      return;
    }
    const groupsRef = ref(db,"groups");
    const newRef = push(groupsRef);
    const g = {
      id: newRef.key,
      name: trimmed,
      createdAt: Date.now()
    };
    set(newRef, g);
    logEvent("CreateGroup", trimmed);
  }

  function renderGroupList(groups){
    groupListEl.innerHTML = "";
    if(!groups.length){
      const empty = document.createElement("p");
      empty.textContent = "まだグループがありません。「＋ グループ作成」から作成してください。";
      groupListEl.appendChild(empty);
      return;
    }
    groups.forEach(g => {
      const card = document.createElement("div");
      card.className = "group-card";
      card.innerHTML = `
        <div class="group-name">${g.name || "名前なしグループ"}</div>
        <div class="group-buttons">
          <button class="btn-blue js-enter">入室</button>
          <button class="js-rename">名前変更</button>
          <button class="js-delete">削除</button>
        </div>
      `;
      const enterBtn = card.querySelector(".js-enter");
      const renameBtn = card.querySelector(".js-rename");
      const deleteBtn = card.querySelector(".js-delete");

      enterBtn.addEventListener("click", () => {
        // 同じページで group クエリを付けて再読み込み
        const p = new URLSearchParams(location.search);
        p.set("group", g.id);
        location.search = p.toString();
      });

      renameBtn.addEventListener("click", () => {
        const newName = prompt("新しいグループ名を入力してください", g.name || "");
        if(newName === null) return;
        const trimmed = newName.trim();
        if(!trimmed){
          alert("グループ名を空にはできません");
          return;
        }
        update(ref(db,"groups/"+g.id), { name: trimmed });
        logEvent("RenameGroup", `${g.name || ""} -> ${trimmed}`);
      });

      deleteBtn.addEventListener("click", () => {
        if(!confirm(`グループ「${g.name || "グループ"}」を削除しますか？\n（中のタイマーもすべて消えます）`)) return;
        remove(ref(db,"groups/"+g.id));
        logEvent("DeleteGroup", g.name || "");
      });

      groupListEl.appendChild(card);
    });
  }

  function setupGroupMode(){
    // groups を購読
    onValue(ref(db,"groups"), snap => {
      const val = snap.val() || {};
      const groups = Object.values(val).sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
      renderGroupList(groups);
    });
  }

  // ========= タイマーまわり =========
  function renderTimers(){
    list.innerHTML = "";
    const arr = Object.values(timers);
    const perCol = 3;
    const cols = Math.ceil(arr.length / perCol);
    for(let c = 0; c < cols; c++){
      const col = document.createElement("div");
      col.className = "column";
      arr.slice(c * perCol, c * perCol + perCol)
         .forEach(t => {
           const el = renderTimer(t);
           if(t.done){
             el.classList.add("done");
           }
           col.appendChild(el);
         });
      list.appendChild(col);
    }
    updateBars();
  }

  function renderTimer(t){
    const d = document.createElement("div");
    d.className = "timer";
    d.dataset.id = t.id;
    d.innerHTML = `
      <input type="text" class="js-name" value="${t.name}">
      <div class="time js-time">${fmt(t.remain)}</div>
      <div class="presets">
        ${[['+1h',3600],['+10min',600],['+5min',300],['+1min',60]].map(([l,s])=>`<button class='btn-blue js-extend' data-sec='${s}'>${l}</button>`).join('')}
      </div>
      <div class="presets">
        ${[['+10sec',10],['+5sec',5],['+1sec',1]].map(([l,s])=>`<button class='btn-blue js-extend' data-sec='${s}'>${l}</button>`).join('')}
        <button class='js-reset'>再設定</button>
      </div>
      <div class="progress"><div class="bar js-bar"></div></div>
      <div class="presets">
        <button class='js-start'>Start</button>
        <button class='js-pause'>Pause</button>
        <button class='js-reset2'>Reset</button>
        <button class='js-delete'>Delete</button>
      </div>
    `;
    d.querySelector(".js-name").addEventListener("change", e => {
      clearTimerDone(t.id);
      updateTimer(t.id, { name: e.target.value });
    });
    d.querySelectorAll(".js-extend").forEach(b =>
      b.addEventListener("click", () => extendTimer(t.id, Number(b.dataset.sec)))
    );
    d.querySelector(".js-reset").addEventListener("click", () => resetTimer(t.id, true));
    d.querySelector(".js-reset2").addEventListener("click", () => resetTimer(t.id, false));
    d.querySelector(".js-start").addEventListener("click", () => startTimer(t.id));
    d.querySelector(".js-pause").addEventListener("click", () => pauseTimer(t.id));
    d.querySelector(".js-delete").addEventListener("click", () => deleteTimer(t.id));
    return d;
  }

  function updateBars(){
    document.querySelectorAll(".timer").forEach(box => {
      const id = box.dataset.id;
      const t = timers[id];
      if(!t) return;
      box.querySelector(".js-time").textContent = fmt(t.remain);
      const bar = box.querySelector(".js-bar");
      const pct = t.total > 0 ? Math.max(0, Math.min(100, (1 - (t.remain / t.total)) * 100)) : 0;
      bar.style.width = pct + "%";
      box.querySelectorAll(".js-extend").forEach(b => b.disabled = t.running);
    });
  }

  function markTimerDone(id){
    const el = document.querySelector(`.timer[data-id="${id}"]`);
    if(el) el.classList.add("done");
    updateTimer(id, { done: true });
  }

  function clearTimerDone(id){
    const el = document.querySelector(`.timer[data-id="${id}"]`);
    if(el) el.classList.remove("done");
    updateTimer(id, { done: false });
  }

  function getRemain(t, now){
    if(t.running && t.startTime && typeof t.total === "number"){
      const elapsed = Math.floor((now - t.startTime) / 1000);
      return Math.max(0, t.total - elapsed);
    }
    if(typeof t.remain === "number"){
      return t.remain;
    }
    return 0;
  }

  function newTimerObj(sec){
    const id = push(ref(db, "groups/"+currentGroupId+"/timers")).key;
    return {
      id,
      name: "タイマー",
      total: sec,
      remain: sec,
      running: false,
      startTime: null,
      lastUpdate: Date.now(),
      initial: sec,
      done: false
    };
  }

  function addTimer(){
    const v = prompt("タイマー時間を入力 (例: 1h, 3m, 90s, 120)");
    if(v === null) return;
    const sec = parseDuration(v);
    if(!sec){
      alert("正しい値を入力してください");
      return;
    }
    const t = newTimerObj(sec);
    set(ref(db,"groups/"+currentGroupId+"/timers/"+t.id), t);
    logEvent("Create", `${t.name} total=${t.total}s`);
  }

  function parseDuration(text){
    if(!text) return null;
    const t = text.trim();
    const hh = t.match(/(\d+)h/i);
    const mm = t.match(/(\d+)m/i);
    const ss = t.match(/(\d+)s/i);
    let sec = 0;
    if(hh) sec += parseInt(hh[1], 10) * 3600;
    if(mm) sec += parseInt(mm[1], 10) * 60;
    if(ss) sec += parseInt(ss[1], 10);
    if(!hh && !mm && !ss){
      const num = parseInt(t, 10);
      if(!isNaN(num)) sec = num;
    }
    return sec > 0 ? sec : null;
  }

  function importFromCsv(text){
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    if(!lines.length) return;
    let startIndex = 0;
    const headerLower = lines[0].toLowerCase();
    if(headerLower.includes("name") && (headerLower.includes("duration") || headerLower.includes("time"))){
      startIndex = 1;
    }
    for(let i = startIndex; i < lines.length; i++){
      const cols = lines[i].split(",");
      if(!cols.length) continue;
      const name = cols[0].trim();
      const durStr = (cols[1] || "").trim();
      const sec = parseDuration(durStr);
      if(!sec) continue;
      const t = newTimerObj(sec);
      if(name) t.name = name;
      set(ref(db, "groups/"+currentGroupId+"/timers/" + t.id), t);
      logEvent("Import", (t.name || "タイマー") + " " + sec + "s");
    }
  }

  function updateTimer(id, data){
    if(!currentGroupId) return;
    update(ref(db, "groups/"+currentGroupId+"/timers/"+id), data);
  }

  function extendTimer(id, sec){
    clearTimerDone(id);
    const t = timers[id];
    if(!t || t.running) return;
    updateTimer(id, { remain: t.remain + sec, total: t.total + sec });
    logEvent("Extend", `${t.name} +${sec}s`);
  }

  function resetTimer(id, toZero){
    clearTimerDone(id);
    const t = timers[id];
    if(!t) return;
    const newRemain = toZero ? 0 : t.initial;
    updateTimer(id, { remain: newRemain, running:false, lastUpdate: Date.now() });
    logEvent("Reset", t.name);
  }

  function startTimer(id){
    clearTimerDone(id);
    const t = timers[id];
    if(!t || t.running) return;
    updateTimer(id, {
      running:true,
      startTime: Date.now(),
      lastUpdate: Date.now(),
      total: t.remain
    });
    logEvent("Start", t.name);
  }

  function pauseTimer(id){
    clearTimerDone(id);
    const t = timers[id];
    if(!t || !t.running) return;
    updateTimer(id, { running:false, lastUpdate: Date.now(), total: t.remain });
    logEvent("Pause", t.name);
  }

  function deleteTimer(id){
    clearTimerDone(id);
    if(!confirm("削除しますか？")) return;
    remove(ref(db, "groups/"+currentGroupId+"/timers/"+id));
    logEvent("Delete", id);
  }

  function exportCsv(){
    const head = "timestamp,timer_name,remain_seconds,total_seconds\n";
    const rows = Object.values(timers)
      .map(t => {
        const now = Date.now();
        const remain = getRemain(t, now);
        const total = typeof t.total === "number" ? t.total : remain;
        return (
          new Date().toISOString() +
          "," +
          (t.name || "タイマー") +
          "," +
          remain +
          "," +
          total
        );
      })
      .join("\n");
    const blob = new Blob([head + rows], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "timers.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // CSV インポート
  importInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const text = ev.target && typeof ev.target.result === "string" ? ev.target.result : "";
      if(text) importFromCsv(text);
    };
    reader.readAsText(file);
  });

  // ========= タイマーのRTDB購読 & カウントダウン =========
  function setupTimerMode(){
    if(!currentGroupId) return;

    onValue(ref(db, "groups/"+currentGroupId+"/timers"), snap => {
      timers = snap.val() || {};
      renderTimers();
    });

    setInterval(() => {
      const now = Date.now();
      const newCompletedIds = [];
      Object.values(timers).forEach(t => {
        if(t.running && t.startTime){
          const elapsed = Math.floor((now - t.startTime) / 1000);
          const remain = Math.max(0, t.total - elapsed);
          t.remain = remain;
          if(remain === 0 && t.running){
            update(ref(db,"groups/"+currentGroupId+"/timers/"+t.id), {
              running:false,
              done:true
            });
            newCompletedIds.push(t.id);
          }
        }
      });
      if(newCompletedIds.length){
        newCompletedIds.forEach(id => {
          markTimerDone(id);
        });
        newCompletedIds.forEach(id => {
          if(!pendingCompletedIds.includes(id)){
            pendingCompletedIds.push(id);
          }
        });
        doneList.innerHTML = pendingCompletedIds
          .map(id => {
            const tt = timers[id];
            return `<li>${tt ? (tt.name || "タイマー") : "タイマー"}</li>`;
          })
          .join("");
        doneModal.style.display = "flex";
        if(unlocked) startRepeatingBeep();
      }
      updateBars();
    }, 1000);
  }

  // ========= モーダルのボタン =========
  doneStop.addEventListener("click", () => stopRepeatingBeep());
  doneOk.addEventListener("click", () => {
    stopRepeatingBeep();
    doneModal.style.display = "none";
    pendingCompletedIds = [];
    doneList.innerHTML = "";
  });

  // ========= 起動時の分岐 =========
  renderHeader();
  renderLayout();

  if(!currentGroupId){
    setupGroupMode();
  }else{
    setupTimerMode();
  }
</script>
</body>
</html>

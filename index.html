<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSIIPz6Q8RRH1ijLcU-SD74IWk10lt2Uk",
  authDomain: "multi-timer-share.firebaseapp.com",
  projectId: "multi-timer-share",
  storageBucket: "multi-timer-share.firebasestorage.app",
  messagingSenderId: "619054972489",
  appId: "1:619054972489:web:ee1a5ad15da335f2e68998",
  databaseURL: "https://multi-timer-share-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const list = document.getElementById('list');
const addBtn = document.getElementById('addTimer');
let timers = {};
let initialTimes = {}; // å„ã‚¿ã‚¤ãƒãƒ¼ã®åˆæœŸè¨­å®šæ™‚é–“ã‚’ä¿æŒ

function logEvent(action, detail="") {
  const ts = new Date().toISOString();
  push(ref(db, 'logs'), { action, detail, timestamp: ts });
}

function fmt(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function render() {
  list.innerHTML = '';
  const arr = Object.values(timers);
  const cols = Math.ceil(arr.length / 5);
  for (let c = 0; c < cols; c++) {
    const col = document.createElement('div');
    col.className = 'column';
    arr.slice(c * 5, c * 5 + 5).forEach(t => col.appendChild(renderTimer(t)));
    list.appendChild(col);
  }
  updateBars();
}

function renderTimer(t) {
  const d = document.createElement('div');
  d.className = 'timer';
  d.dataset.id = t.id;
  d.innerHTML = `
    <input type="text" class="js-name" value="${t.name}">
    <div class="time js-time">${fmt(t.remain)}</div>
    <div class="presets">
      ${[['+1h',3600],['+10min',600],['+5min',300],['+1min',60]].map(([l,s])=>`<button class='btn-blue js-extend' data-sec='${s}'>${l}</button>`).join('')}
    </div>
    <div class="presets">
      ${[['+10sec',10],['+5sec',5],['+1sec',1]].map(([l,s])=>`<button class='btn-blue js-extend' data-sec='${s}'>${l}</button>`).join('')}
      <button class='js-reset'>å†è¨­å®š</button>
    </div>
    <div class="progress"><div class="bar js-bar"></div></div>
    <div class="presets">
      <button class='js-start'>Start</button>
      <button class='js-pause'>Pause</button>
      <button class='js-resetInit'>Reset</button>
      <button class='js-delete'>Delete</button>
    </div>`;
  
  d.querySelector('.js-name').addEventListener('change',e=>updateTimer(t.id,{name:e.target.value}));
  d.querySelectorAll('.js-extend').forEach(b=>b.addEventListener('click',()=>extendTimer(t.id,Number(b.dataset.sec))));
  d.querySelector('.js-reset').addEventListener('click',()=>resetZero(t.id));
  d.querySelector('.js-resetInit').addEventListener('click',()=>resetInit(t.id));
  d.querySelector('.js-start').addEventListener('click',()=>startTimer(t.id));
  d.querySelector('.js-pause').addEventListener('click',()=>pauseTimer(t.id));
  d.querySelector('.js-delete').addEventListener('click',()=>deleteTimer(t.id));
  return d;
}

function updateBars() {
  document.querySelectorAll('.timer').forEach(box => {
    const id = box.dataset.id;
    const t = timers[id];
    if (!t) return;
    box.querySelector('.js-time').textContent = fmt(t.remain);
    const bar = box.querySelector('.js-bar');
    const pct = t.total > 0 ? Math.max(0, Math.min(100, (1 - (t.remain / t.total)) * 100)) : 0;
    bar.style.width = pct + '%';
    box.querySelectorAll('.js-extend').forEach(b => b.disabled = t.running);
  });
}

function newTimerObj(sec) {
  const id = push(ref(db, 'timers')).key;
  initialTimes[id] = sec;
  return { id, name: 'ã‚¿ã‚¤ãƒãƒ¼', total: sec, remain: sec, running: false, startTime: null };
}

function addTimer() {
  const v = prompt('ã‚¿ã‚¤ãƒãƒ¼æ™‚é–“ã‚’å…¥åŠ› (ä¾‹: 1h, 3m, 90s, 120)');
  if (v === null) return;
  const sec = parseDuration(v);
  if (!sec) { alert('æ­£ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const t = newTimerObj(sec);
  set(ref(db, 'timers/' + t.id), t);
  logEvent('Create', `${t.name} total=${t.total}s`);
}

function parseDuration(text) {
  if (!text) return null;
  const t = text.trim();
  const mm = t.match(/(\d+)m/i);
  const ss = t.match(/(\d+)s/i);
  let sec = 0;
  if (mm) sec += parseInt(mm[1]) * 60;
  if (ss) sec += parseInt(ss[1]);
  if (!mm && !ss) sec = parseInt(t) || 0;
  return sec > 0 ? sec : null;
}

function updateTimer(id, data) { update(ref(db, 'timers/' + id), data); }
function extendTimer(id, sec) {
  const t = timers[id];
  if (!t || t.running) return;
  t.total += sec; t.remain += sec;
  updateTimer(id, { total: t.total, remain: t.remain });
}
function resetZero(id) { updateTimer(id, { remain: 0, running: false }); }
function resetInit(id) {
  const init = initialTimes[id];
  if (init != null) updateTimer(id, { remain: init, total: init, running: false });
}
function startTimer(id) {
  const t = timers[id];
  if (!t || t.running) return;
  updateTimer(id, { running: true, startTime: Date.now() });
}
function pauseTimer(id) { updateTimer(id, { running: false }); }
function deleteTimer(id) { remove(ref(db, 'timers/' + id)); }

onValue(ref(db, 'timers'), snap => {
  timers = snap.val() || {};
  render();
});

// ğŸ” ãƒ­ãƒ¼ã‚«ãƒ«æç”»æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
setInterval(() => {
  Object.values(timers).forEach(t => {
    if (t.running && t.remain > 0) {
      t.remain--;
      updateBars();
      if (t.remain <= 0) logEvent('Completed', t.name);
    }
  });
}, 1000);

// ğŸ” Firebase åŒæœŸï¼ˆ10ç§’ã”ã¨ï¼‰
setInterval(() => {
  Object.values(timers).forEach(t => {
    update(ref(db, 'timers/' + t.id), { remain: t.remain });
  });
}, 10000);

addBtn.addEventListener('click', addTimer);
</script>
